<script>
    let paroquiasData = {};
    let updateInterval;

    // Fun√ß√£o para buscar dados do arquivo CSV
    async function carregarDados() {
        try {
            const timestamp = new Date().getTime();
            // ‚û°Ô∏è CORRE√á√ÉO 1: Agora busca o arquivo dados.csv
            const response = await fetch(`./dados.csv?t=${timestamp}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            // ‚û°Ô∏è CORRE√á√ÉO 2: L√™ o conte√∫do como texto CSV
            const csvData = await response.text();
            
            // ‚û°Ô∏è CORRE√á√ÉO 3: L√≥gica para converter o CSV em um objeto JavaScript
            const lines = csvData.split('\n').filter(line => line.trim() !== '');
            const headers = lines[0].split(','); // Ignora o cabe√ßalho
            
            const newData = {};
            for (let i = 1; i < lines.length; i++) {
                // Usa uma express√£o regular para lidar com v√≠rgulas dentro de aspas
                const values = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                if (values.length >= 2) {
                    const paroquia = values[0].replace(/"/g, '').trim();
                    const count = parseInt(values[1].replace(/"/g, '').trim(), 10) || 0;
                    newData[paroquia] = count;
                }
            }
            
            paroquiasData = newData; // Atualiza os dados globais
            
            atualizarInterface();
            esconderErro();
            
            document.querySelector('.paroquias-container').classList.add('success-pulse');
            setTimeout(() => {
                document.querySelector('.paroquias-container').classList.remove('success-pulse');
            }, 500);
            
        } catch (error) {
            console.error('Erro ao carregar dados:', error);
            mostrarErro('Erro ao carregar dados. Tentando novamente...');
            
            if (Object.keys(paroquiasData).length === 0) {
                 paroquiasData = {
                    "Par√≥quia Senhora Sant'Ana ‚Äì Varjota": 12,
                    "Par√≥quia Nossa Senhora do Perp√©tuo Socorro ‚Äì Reriutaba": 5,
                    "Par√≥quia de Santa Quit√©ria ‚Äì Santa Quit√©ria": 4,
                    "Par√≥quia Nossa Senhora do Perp√©tuo Socorro ‚Äì Pires Ferreira": 2
                 };
                atualizarInterface();
            }
        }
    }

    // Fun√ß√£o para atualizar a interface (sem mudan√ßas necess√°rias)
    function atualizarInterface() {
        const paroquias = Object.keys(paroquiasData);
        const totalInscricoes = Object.values(paroquiasData).reduce((sum, count) => sum + count, 0);
        const paroquiasComInscricoes = paroquias.filter(p => paroquiasData[p] > 0);
        const totalParoquias = paroquiasComInscricoes.length;
        const mediaParoquia = totalParoquias > 0 ? Math.round(totalInscricoes / totalParoquias * 10) / 10 : 0;

        document.getElementById('total-inscricoes').textContent = totalInscricoes;
        document.getElementById('total-paroquias').textContent = totalParoquias;
        document.getElementById('media-paroquia').textContent = mediaParoquia;

        const sortedParoquias = paroquias.sort((a, b) => paroquiasData[b] - paroquiasData[a]);

        const paroquiasList = document.getElementById('paroquias-list');
        paroquiasList.innerHTML = sortedParoquias
            .filter(paroquia => paroquiasData[paroquia] > 0)
            .map(paroquia => `
                <div class="paroquia-item">
                    <div class="paroquia-name">${paroquia}</div>
                    <div class="paroquia-count">${paroquiasData[paroquia]}</div>
                </div>
            `).join('');

        if (paroquiasList.innerHTML === '') {
            paroquiasList.innerHTML = sortedParoquias.map(paroquia => `
                <div class="paroquia-item">
                    <div class="paroquia-name">${paroquia}</div>
                    <div class="paroquia-count">${paroquiasData[paroquia]}</div>
                </div>
            `).join('');
        }

        document.getElementById('loading').style.display = 'none';
        
        const now = new Date();
        document.getElementById('last-update').textContent = now.toLocaleString('pt-BR');
    }

    // As fun√ß√µes mostrarErro, esconderErro, atualizarDados, verificarUltimaModificacao 
    // e o bloco de inicializa√ß√£o
    function mostrarErro(message) {
        document.getElementById('error-message').innerHTML = `
            <div class="error-message">
                ‚ùå ${message}
            </div>
        `;
    }

    function esconderErro() {
        document.getElementById('error-message').innerHTML = '';
    }

    async function atualizarDados() {
        const button = document.querySelector('.manual-refresh');
        const originalText = button.textContent;
        
        button.textContent = 'üîÑ Atualizando...';
        button.style.opacity = '0.6';
        button.disabled = true;
        
        await carregarDados();
        
        setTimeout(() => {
            button.textContent = originalText;
            button.style.opacity = '1';
            button.disabled = false;
        }, 1000);
    }

    function verificarUltimaModificacao() {
        // ‚û°Ô∏è CORRE√á√ÉO 4: A busca agora √© por dados.csv
        fetch('./dados.csv', { method: 'HEAD' })
            .then(response => {
                const lastModified = response.headers.get('last-modified');
                if (lastModified) {
                    const modifiedDate = new Date(lastModified);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - modifiedDate) / (1000 * 60));
                    
                    if (diffMinutes < 15) {
                        document.getElementById('next-update').innerHTML = 
                            `‚ú® Dados atualizados h√° ${diffMinutes} minuto${diffMinutes !== 1 ? 's' : ''} pela automa√ß√£o`;
                    }
                }
            })
            .catch(() => {});
    }

    // Bloco de Inicializa√ß√£o (j√° estava correto)
    document.addEventListener('DOMContentLoaded', () => {
        carregarDados();
        verificarUltimaModificacao();
        
        updateInterval = setInterval(() => {
            carregarDados();
            verificarUltimaModificacao();
        }, 120000); // 2 minutos
    });

    window.addEventListener('beforeunload', () => {
        if (updateInterval) clearInterval(updateInterval);
    });

    window.addEventListener('focus', () => {
        carregarDados();
    });
</script>
